import streamlit as st
import requests
import json
import base64
from io import BytesIO
from gtts import gTTS
from PIL import Image

# --- CONFIGURATION ---
st.set_page_config(page_title="Vista Vocale", layout="wide")

try:
    API_KEY = st.secrets["GEMINI_API_KEY"]
except:
    st.error("‚ùå API Key missing. Please check Secrets.")
    st.stop()

# --- STYLING ---
st.markdown("""
    <style>
    /* Compact Tabs for Mobile */
    button[data-baseweb="tab"] { 
        font-size: 16px !important; 
        padding: 8px 12px !important; 
        min-width: 0px !important;
        flex: 1 1 auto;
    }
    h1 { font-size: 2.2rem !important; }
    p, li { font-size: 1.1rem !important; }
    [data-testid="stDownloadButton"] > button { width: 100%; }
    /* Center the selectbox text */
    div[data-baseweb="select"] { text-align: center; }
    /* Pinyin Styling */
    .pinyin { color: #888; font-size: 0.9rem; font-style: italic; margin-bottom: 5px; }
    </style>
""", unsafe_allow_html=True)

# --- LANGUAGE SETTINGS ---
LANG_CONFIG = {
    "üáÆüáπ Italian": {
        "code": "it",
        "name": "Italian",
        "super7": "essere, avere, volere, andare, piacere, c'√®, potere"
    },
    "üá´üá∑ French": {
        "code": "fr",
        "name": "French",
        "super7": "√™tre, avoir, vouloir, aller, aimer, il y a, pouvoir"
    },
    "üá®üá≥ Chinese": {
        "code": "zh-CN",
        "name": "Mandarin Chinese",
        "super7": "ÊòØ (sh√¨), Êúâ (y«íu), Ë¶Å (y√†o), Âéª (q√π), ÂñúÊ¨¢ (x«êhuƒÅn), Âú® (z√†i), ËÉΩ (n√©ng)"
    }
}

# --- 1. AUTO-DISCOVERY ---
@st.cache_data
def get_best_model_name():
    url = f"https://generativelanguage.googleapis.com/v1beta/models?key={API_KEY}"
    try:
        response = requests.get(url)
        if response.status_code != 200:
            return None, f"List Error: {response.status_code}"
        
        data = response.json()
        models = data.get('models', [])
        
        priority_list = [
            "gemini-1.5-flash",
            "gemini-1.5-flash-latest",
            "gemini-1.5-flash-001",
            "gemini-1.5-pro"
        ]
        
        for priority in priority_list:
            for m in models:
                if priority in m['name']:
                    return m['name'], None

        for m in models:
            if "generateContent" in m.get('supportedGenerationMethods', []):
                return m['name'], None
                
        return "models/gemini-1.5-flash", None
        
    except Exception as e:
        return None, str(e)

valid_model_name, model_error = get_best_model_name()

# --- 2. GALLERY DOWNLOADER ---
@st.cache_data(show_spinner=False)
def load_gallery_image(url):
    try:
        headers = {'User-Agent': 'Mozilla/5.0'}
        response = requests.get(url, headers=headers, timeout=5)
        response.raise_for_status()
        return response.content
    except Exception as e:
        return None

# --- 3. HELPER: TEXT FILE GENERATOR ---
def create_lesson_file(data, lang_name):
    text = f"üåç VISTA VOCALE - {lang_name.upper()} LESSON\n"
    text += "==========================================\n\n"
    
    text += "1. VOCABULARY\n"
    text += "-------------\n"
    for item in data.get('vocabulary', []):
        if isinstance(item, dict):
            word = item.get('target_word', '')
            pron = item.get('pronunciation', '') # Get Pinyin
            obj = item.get('object_name', '')
            sent = item.get('target_sentence', '')
            trans = item.get('english_translation', '')
            
            text += f"* {word} ({obj})\n"
            if pron: text += f"  [{pron}]\n" # Add Pinyin line
            text += f"  - {sent}\n"
            text += f"  - {trans}\n\n"

    text += "2. CONVERSATION\n"
    text += "---------------\n"
    for turn in data.get('conversation', []):
        if isinstance(turn, dict):
            speaker = turn.get('speaker', '')
            target = turn.get('target_text', '')
            pron = turn.get('pronunciation', '')
            eng = turn.get('english', '')
            
            text += f"{speaker}: {target}\n"
            if pron: text += f"      [{pron}]\n"
            text += f"      ({eng})\n"
    text += "\n"

    text += "3. STORY\n"
    text += "--------\n"
    for chunk in data.get('story', []):
        if isinstance(chunk, dict):
            target = chunk.get('target_text', '')
            pron = chunk.get('pronunciation', '')
            eng = chunk.get('english', '')
            
            text += f"{target}\n"
            if pron: text += f"[{pron}]\n"
            
            if eng:
                text += f"({eng})\n\n"
            else:
                text += "\n"
    
    text += "\n\n(Generated by Vista Vocale)"
    return text

# --- 4. DIRECT API CALL ---
def call_gemini_direct(image_bytes, model_name, lang_config):
    url = f"https://generativelanguage.googleapis.com/v1beta/{model_name}:generateContent?key={API_KEY}"
    b64_image = base64.b64encode(image_bytes).decode('utf-8')
    
    # --- PROMPT UPDATED FOR PINYIN ---
    prompt_text = f"""
    You are an expert TPRS {lang_config['name']} teacher.
    Analyze the image and create a lesson strictly following these rules:
    
    1. Select 5 High-Frequency Vocabulary words visible in the image.
    2. Create a simple Conversation that uses ONLY these words and "Super 7" verbs: {lang_config['super7']}.
    3. Create a Story (5-6 sentences) that RECYCLES the vocab words.
    4. Keep level A1 (Beginner).

    CRITICAL INSTRUCTION:
    If the language is CHINESE (Mandarin), you MUST fill the "pronunciation" field with Pinyin (with tone marks).
    If the language is Italian or French, leave the "pronunciation" field empty string "".
    
    Return JSON structure:
    {{
      "vocabulary": [{{
          "target_word": "word", 
          "pronunciation": "pinyin OR empty", 
          "target_sentence": "sentence", 
          "english_translation": "eng trans", 
          "object_name": "eng object name"
      }}],
      "conversation": [{{
          "speaker": "Name", 
          "target_text": "text", 
          "pronunciation": "pinyin OR empty",
          "english": "eng trans"
      }}],
      "story": [{{
          "target_text": "sentence", 
          "pronunciation": "pinyin OR empty",
          "english": "eng trans"
      }}]
    }}
    """
    
    payload = {
        "contents": [{
            "parts": [
                {"text": prompt_text},
                {"inline_data": {"mime_type": "image/jpeg", "data": b64_image}}
            ]
        }],
        "generation_config": {"response_mime_type": "application/json"}
    }
    
    try:
        response = requests.post(url, json=payload, headers={'Content-Type': 'application/json'})
        if response.status_code != 200:
            return None, f"API Error ({response.status_code}): {response.text}"
            
        result = response.json()
        if 'candidates' in result and result['candidates']:
             text_content = result['candidates'][0]['content']['parts'][0]['text']
             text_content = text_content.replace('```json', '').replace('```', '')
             return json.loads(text_content), None
        else:
             return None, "AI returned no content."
        
    except Exception as e:
        return None, str(e)

def get_audio_bytes(text, lang_code):
    try:
        tts = gTTS(text=text, lang=lang_code)
        fp = BytesIO()
        tts.write_to_fp(fp)
        fp.seek(0)
        return fp
    except: return None

# --- MAIN APP LAYOUT ---
st.title("üåç Vista Vocale")

if model_error:
    st.error(f"‚ö†Ô∏è Could not find models: {model_error}")
else:
    st.caption(f"‚ú® Connected to: `{valid_model_name}`")

t_upload, t_gallery = st.tabs(["üì∑ Snap Photo", "üñºÔ∏è Gallery"])
final_image_bytes = None

with t_upload:
    uploaded_file = st.file_uploader("Take a photo:", type=["jpg", "png", "jpeg", "webp"])
    if uploaded_file:
        final_image_bytes = uploaded_file.getvalue()

with t_gallery:
    GALLERY = {
        "Select...": None,
        "‚òï Espresso": "https://upload.wikimedia.org/wikipedia/commons/4/45/A_small_cup_of_coffee.JPG",
        "üõ∂ Venice": "https://upload.wikimedia.org/wikipedia/commons/d/d6/Gondola_Venice_2016.jpg",
        "ü•ê Croissant (French)": "https://upload.wikimedia.org/wikipedia/commons/2/28/2018_01_Croissant_IMG_0685.JPG",
        "ü•ü Dumplings (Chinese)": "https://upload.wikimedia.org/wikipedia/commons/9/93/Jiaozi_at_Wangfujing.JPG"
    }
    choice = st.selectbox("Choose scene:", list(GALLERY.keys()))
    if choice and GALLERY[choice]:
        loaded_bytes = load_gallery_image(GALLERY[choice])
        if loaded_bytes:
            final_image_bytes = loaded_bytes
        else:
            st.error("‚ö†Ô∏è Could not download image.")

st.markdown("---")

if final_image_bytes:
    # --- CENTER LAYOUT ---
    c1, c2, c3 = st.columns([1, 2, 1]) 
    with c2:
        st.image(final_image_bytes, use_container_width=True)
        
        # --- LANGUAGE SELECTOR ---
        selected_lang_key = st.selectbox(
            "Select Target Language:", 
            list(LANG_CONFIG.keys()),
            index=0
        )
        current_lang = LANG_CONFIG[selected_lang_key]
        
        # --- BUTTON ---
        if st.button(f"Create {current_lang['name']} Lesson", type="primary", use_container_width=True):
            
            with st.spinner("Analyzing..."):
                lesson_data, error = call_gemini_direct(final_image_bytes, valid_model_name, current_lang)
                
                if error:
                    st.error(error)
                elif lesson_data:
                    # Save results
                    st.session_state['lesson_data'] = lesson_data
                    st.session_state['current_lang'] = current_lang

    # --- DISPLAY RESULTS ---
    if 'lesson_data' in st.session_state:
        data = st.session_state['lesson_data']
        lang = st.session_state['current_lang']
        
        st.markdown("---")
        
        # --- COMPACT TABS ---
        t1, t2, t3, t4, t5 = st.tabs(["üìñ Vocab", "üó£Ô∏è Chat", "üìú Story", "üá∫üá∏ Key", "üíæ Save"])
        
        # --- TAB 1: VOCAB ---
        with t1:
            vocab_list = data.get('vocabulary', [])
            if isinstance(vocab_list, list):
                for item in vocab_list:
                    if isinstance(item, dict):
                        c1, c2 = st.columns([3, 1])
                        with c1:
                            st.markdown(f"**{item.get('target_word', '')}**")
                            # --- PINYIN DISPLAY ---
                            if item.get('pronunciation'):
                                st.markdown(f"<div class='pinyin'>{item.get('pronunciation')}</div>", unsafe_allow_html=True)
                            
                            st.markdown(f"_{item.get('target_sentence', '')}_")
                        with c2:
                            ab = get_audio_bytes(f"{item.get('target_word', '')}... {item.get('target_sentence', '')}", lang['code'])
                            if ab: st.audio(ab, format='audio/mp3')
                        st.divider()
                    
        # --- TAB 2: CHAT ---
        with t2:
            chat_list = data.get('conversation', [])
            if isinstance(chat_list, list):
                for turn in chat_list:
                    c1, c2 = st.columns([3, 1])
                    with c1:
                        if isinstance(turn, dict):
                            speaker = turn.get('speaker', 'Speaker')
                            text = turn.get('target_text', '')
                            pron = turn.get('pronunciation', '')
                            
                            st.markdown(f"**{speaker}**: {text}")
                            # --- PINYIN DISPLAY ---
                            if pron:
                                st.markdown(f"<div class='pinyin'>{pron}</div>", unsafe_allow_html=True)
                        else:
                            st.markdown(str(turn))
                            text = str(turn)
                    with c2:
                        ab = get_audio_bytes(text, lang['code'])
                        if ab: st.audio(ab, format='audio/mp3')
                    st.divider()

        # --- TAB 3: STORY ---
        with t3:
            story_list = data.get('story', [])
            if isinstance(story_list, list):
                for chunk in story_list:
                    c1, c2 = st.columns([3, 1])
                    with c1:
                        if isinstance(chunk, dict):
                            text = chunk.get('target_text', '')
                            pron = chunk.get('pronunciation', '')
                            
                            st.markdown(f"üìñ {text}")
                            # --- PINYIN DISPLAY ---
                            if pron:
                                st.markdown(f"<div class='pinyin'>{pron}</div>", unsafe_allow_html=True)
                        else:
                            text = str(chunk)
                            st.markdown(f"üìñ {text}")
                    with c2:
                        ab = get_audio_bytes(text, lang['code'])
                        if ab: st.audio(ab, format='audio/mp3')
                    st.divider()

        # --- TAB 4: TRANSLATIONS ---
        with t4:
            st.header("üá∫üá∏ Answer Key")
            st.subheader("1. Vocabulary")
            if isinstance(vocab_list, list):
                for item in vocab_list:
                        if isinstance(item, dict):
                            st.markdown(f"**{item.get('target_word')}** = *{item.get('object_name')}*")
                            st.caption(f"Sent: {item.get('english_translation')}")
                            st.divider()

            st.subheader("2. Conversation")
            if isinstance(chat_list, list):
                for turn in chat_list:
                        if isinstance(turn, dict):
                            st.markdown(f"**{turn.get('speaker')}**: {turn.get('english')}")

            st.markdown("---")
            st.subheader("3. Story")
            if isinstance(story_list, list):
                for chunk in story_list:
                        if isinstance(chunk, dict):
                            st.markdown(f"_{chunk.get('english')}_")
                            st.markdown("")

        # --- TAB 5: PRINT / SAVE ---
        with t5:
            st.header("üíæ Download")
            lesson_text = create_lesson_file(data, lang['name'])
            
            st.download_button(
                label=f"üì• Download (.txt)",
                data=lesson_text,
                file_name=f"{lang['name']}_Lesson.txt",
                mime="text/plain"
            )
            st.markdown("---")
            st.text(lesson_text)
